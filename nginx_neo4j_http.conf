# GraphRAG + Neo4j 统一网关配置（使用 Neo4j HTTP API）
# 所有服务通过 80 端口访问

server {
    listen 80;
    server_name localhost 172.19.153.235;
    
    # 增加超时时间，适应长时间查询
    proxy_read_timeout 300s;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    
    # WebSocket 支持
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # 通用代理头
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # ==========================================
    # Neo4j Browser (HTTP 界面)
    # 访问路径: http://localhost/neo4j/
    # ==========================================
    location /neo4j/ {
        proxy_pass http://localhost:7474/;
        
        # Neo4j Browser 需要的特殊头
        proxy_set_header Accept-Encoding "";
        
        # 替换响应中的链接
        sub_filter 'href="/' 'href="/neo4j/';
        sub_filter 'src="/' 'src="/neo4j/';
        sub_filter_once off;
    }
    
    # ==========================================
    # Neo4j HTTP API (用于 Cypher 查询)
    # 访问路径: http://localhost/neo4j-db/
    # 这个路径代理到 Neo4j 的 /db/ 端点
    # ==========================================
    location /neo4j-db/ {
        proxy_pass http://localhost:7474/db/;
        
        # 允许 POST 请求和 JSON
        proxy_set_header Content-Type application/json;
        proxy_set_header Accept application/json;
    }
    
    # ==========================================
    # GraphRAG API 服务
    # 访问路径: http://localhost/api/*
    # ==========================================
    location /api/ {
        proxy_pass http://localhost:8000/api/;
    }
    
    # ==========================================
    # GraphRAG 静态文件和主页
    # 访问路径: http://localhost/
    # ==========================================
    location / {
        proxy_pass http://localhost:8000/;
    }
}
