<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>çŸ¥è¯†è¿æˆç½‘ï¼Œå­¦ä¹ æœ‰æ–¹å‘</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network@9.1.2/dist/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input[type="text"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input[type="text"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
            display: none;
        }

        .result-card.show {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .result-header h2 {
            color: #333;
            font-size: 1.5em;
        }

        .result-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .meta-item {
            background: #f5f5f5;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            color: #666;
        }

        .meta-item strong {
            color: #333;
        }

        .result-content {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            line-height: 1.8;
            word-wrap: break-word;
        }

        .result-content h1,
        .result-content h2,
        .result-content h3,
        .result-content h4,
        .result-content h5,
        .result-content h6 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #333;
        }

        .result-content h1 {
            font-size: 1.8em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .result-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .result-content h3 {
            font-size: 1.3em;
        }

        .result-content p {
            margin-bottom: 15px;
        }

        .result-content ul,
        .result-content ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .result-content li {
            margin-bottom: 8px;
        }

        .result-content code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #d63384;
        }

        .result-content pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 15px;
        }

        .result-content pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        .result-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }

        .result-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 15px;
        }

        .result-content table th,
        .result-content table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .result-content table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .result-content table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .result-content a {
            color: #667eea;
            text-decoration: none;
        }

        .result-content a:hover {
            text-decoration: underline;
        }

        .result-content hr {
            border: none;
            border-top: 2px solid #e0e0e0;
            margin: 20px 0;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #c33;
            margin-top: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.online {
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }

        .status-indicator.offline {
            background: #f44336;
        }

        .examples {
            margin-top: 20px;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
        }

        .examples h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .example-btn {
            display: inline-block;
            background: white;
            color: #667eea;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            border: 2px solid #667eea;
            transition: all 0.3s;
        }

        .example-btn:hover {
            background: #667eea;
            color: white;
        }

        #neo4jViz {
            width: 100%;
            height: 600px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .graph-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .graph-controls input,
        .graph-controls select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .graph-controls button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .graph-controls button:hover {
            transform: translateY(-2px);
        }

        .nl-example-btn {
            display: inline-block;
            background: white;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 12px;
            border: 1.5px solid #667eea;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nl-example-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .main-card, .result-card {
                padding: 20px;
            }
            
            #neo4jViz {
                height: 400px;
            }
            
            #floatingNodeInfo {
                max-width: 90% !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” çŸ¥è¯†è¿æˆç½‘ï¼Œå­¦ä¹ æœ‰æ–¹å‘ï¼</h1>
            <p>ä½¿ç”¨äººå·¥æ™ºèƒ½å‰æ²¿GraphRAGæŠ€æœ¯æ„å»ºçŸ¥è¯†å›¾è°±ï¼Œå¿«æ¥è¯•è¯•å§</p>
            <div style="margin-top: 15px;">
                <button onclick="toggleUploadPanel()" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 10px;">
                    ğŸ“¤ æ›´æ–°å›¾è°±
                </button>
                <!-- <button onclick="toggleTasksPanel()" style="background: white; color: #764ba2; border: 2px solid #764ba2; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 10px;">
                    ğŸ“‹ æŸ¥çœ‹ç´¢å¼•ä»»åŠ¡
                </button> -->
                <button onclick="toggleGraphPanel()" style="background: white; color: #f093fb; border: 2px solid #f093fb; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 10px;">
                    ğŸ•¸ï¸ å›¾è°±å¯è§†åŒ–
                </button>
                <!-- <a href="/static/api-docs.html" target="_blank" style="display: inline-block; background: white; color: #ff9800; border: 2px solid #ff9800; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; text-decoration: none;">
                    ğŸ“š API æ–‡æ¡£
                </a> -->
            </div>
        </div>

        <!-- å›¾è°±å¯è§†åŒ–é¢æ¿ -->
        <div class="main-card" id="graphPanel" style="display: none;">
            <h2 style="color: #f093fb; margin-bottom: 15px;">ğŸ•¸ï¸ Neo4j å›¾è°±å¯è§†åŒ–</h2>
            <p style="color: #666; margin-bottom: 20px;">åœ¨è¿™é‡ŒæŸ¥çœ‹æ•´ä¸ªçŸ¥è¯†ç½‘ç»œ</p>
            
            <div class="graph-controls">
                <input type="text" id="neo4jHttpUrl" placeholder="Neo4j HTTP API URL" value="http://localhost/neo4j-db/neo4j" style="flex: 1; min-width: 250px;">
                <input type="text" id="neo4jUser" placeholder="ç”¨æˆ·å" value="neo4j" style="width: 150px;">
                <input type="password" id="neo4jPassword" placeholder="å¯†ç " value="neo4j" style="width: 150px;">
            </div>
            
            <!-- <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 3px solid #2196f3;">
                <strong style="color: #1976d2;">ğŸ’¡ å¿«é€Ÿè¿æ¥æç¤ºï¼ˆä»…éœ€ 80 ç«¯å£ï¼‰ï¼š</strong><br>
                <span style="font-size: 13px; color: #666;">
                    â€¢ é€šè¿‡ Nginx ä»£ç†ï¼š<code style="background: #fff; padding: 2px 6px; border-radius: 3px;">http://localhost/neo4j-db/neo4j</code><br>
                    â€¢ è¿œç¨‹è®¿é—®ï¼š<code style="background: #fff; padding: 2px 6px; border-radius: 3px;">http://YOUR_IP/neo4j-db/neo4j</code><br>
                    â€¢ é»˜è®¤å¯†ç é€šå¸¸æ˜¯ <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">neo4j</code>ï¼ˆé¦–æ¬¡ç™»å½•åéœ€ä¿®æ”¹ï¼‰
                </span>
            </div> -->

            <!-- è‡ªç„¶è¯­è¨€æŸ¥è¯¢ -->
            <div style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 8px; border: 2px solid #667eea;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #667eea;">ğŸ’¬ è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼ˆAI è‡ªåŠ¨è½¬æ¢ä¸º Cypherï¼‰ï¼š</label>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input 
                        type="text" 
                        id="nlQuery" 
                        placeholder="ä¾‹å¦‚ï¼šæ‰¾å‡ºæ‰€æœ‰ä¸'ç»†èƒ'ç›¸å…³çš„å®ä½“"
                        style="flex: 1; padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px;"
                    >
                    <button onclick="executeNLQuery()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                        ğŸ¤– AI æŸ¥è¯¢
                    </button>
                </div>
                
                <!-- ç¤ºä¾‹æŸ¥è¯¢ -->
                <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 6px; font-weight: 600;">ğŸ’¡ ç¤ºä¾‹æŸ¥è¯¢ï¼š</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        <button onclick="setNLExample('æ‰¾å‡ºæ‰€æœ‰ä¸ç»†èƒç›¸å…³çš„æ‰€æœ‰å®ä½“ã€å…³ç³»å’Œæ–‡æ¡£')" class="nl-example-btn">æ‰¾å‡ºæ‰€æœ‰ä¸ç»†èƒç›¸å…³çš„æ‰€æœ‰å®ä½“ã€å…³ç³»å’Œæ–‡æ¡£</button>
                        <button onclick="setNLExample('æŸ¥æ‰¾åŒ…å«å…‰åˆä½œç”¨çš„æ–‡æœ¬å—')" class="nl-example-btn">æŸ¥æ‰¾åŒ…å«å…‰åˆä½œç”¨çš„æ–‡æœ¬å—</button>
                        <button onclick="setNLExample('æ˜¾ç¤ºæ‰€æœ‰å…³ç³»èŠ‚ç‚¹')" class="nl-example-btn">æ˜¾ç¤ºæ‰€æœ‰å…³ç³»èŠ‚ç‚¹</button>
                        <button onclick="setNLExample('æŸ¥æ‰¾å¶ç»¿ä½“çš„å®ä½“èŠ‚ç‚¹å’Œä¸ä¹‹æœ‰å…³è”çš„æ‰€æœ‰èŠ‚ç‚¹å’Œå…³ç³»')" class="nl-example-btn">æŸ¥æ‰¾å¶ç»¿ä½“çš„å®ä½“èŠ‚ç‚¹å’Œä¸ä¹‹æœ‰å…³è”çš„æ‰€æœ‰èŠ‚ç‚¹å’Œå…³ç³»</button>
                    </div>
                </div>
                
                <div id="generatedCypher" style="display: none; margin-top: 10px; padding: 10px; background: white; border-radius: 6px; border-left: 3px solid #4caf50;">
                    <strong style="color: #4caf50;">âœ… ç”Ÿæˆçš„ Cypherï¼š</strong>
                    <pre id="generatedCypherCode" style="margin-top: 8px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px; overflow-x: auto; white-space: pre-wrap; word-break: break-word;"></pre>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Cypher æŸ¥è¯¢ï¼š</label>
                <textarea id="cypherQuery" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: 'Courier New', monospace; min-height: 80px;">MATCH (n)-[r]->(m) RETURN n, r, m LIMIT 100</textarea>
                <button onclick="executeNeo4jQuery()" style="margin-top: 10px; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    â–¶ï¸ æ‰§è¡ŒæŸ¥è¯¢
                </button>
            </div>

            <div id="graphStatus" style="margin-bottom: 15px; padding: 10px; background: #f0f4ff; border-radius: 6px;"></div>

            <div id="neo4jViz" style="width: 100%; height: 600px; border: 2px solid #e0e0e0; border-radius: 8px; background: #fafafa; position: relative;"></div>

            <!-- æµ®åŠ¨èŠ‚ç‚¹ä¿¡æ¯çª—å£ -->
            <div id="floatingNodeInfo" style="
                position: absolute;
                top: 10px;
                right: 10px;
                display: none;
                width: 350px;
                max-height: 500px;
                background: white;
                border: 2px solid #667eea;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.25);
                padding: 0;
                z-index: 1000;
                font-size: 13px;
                animation: fadeIn 0.2s ease-in-out;
            "></div>
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 12px 15px;
                    border-radius: 10px 10px 0 0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <span id="floatingNodeTitle" style="font-weight: 600; font-size: 14px;"></span>
                    <button onclick="closeFloatingInfo()" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 16px;
                        line-height: 1;
                        transition: background 0.2s;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">Ã—</button>
                </div>
                <div id="floatingNodeContent" style="
                    padding: 15px;
                    max-height: 400px;
                    overflow-y: auto;
                    line-height: 1.6;
                    color: #333;
                "></div>
            </div>

            <!-- <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;"></div>
                <h3 style="margin: 0 0 12px 0; color: #f093fb; font-size: 1.1em;">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
                <div style="font-size: 13px; color: #666; line-height: 1.6;">
                    <strong>ğŸ“Œ å¿«é€Ÿå¼€å§‹ï¼š</strong><br>
                    1. ç¡®ä¿ Neo4j æ­£åœ¨è¿è¡Œ<br>
                    2. è¾“å…¥æ‚¨çš„ Neo4j å¯†ç ï¼ˆé»˜è®¤ç”¨æˆ·å: neo4jï¼‰<br>
                    3. ç‚¹å‡»"ğŸ”Œ è¿æ¥å¹¶å¯è§†åŒ–"<br><br>
                    
                    <strong>ğŸ”§ è¿æ¥é…ç½®ï¼š</strong><br>
                    â€¢ <strong>URL:</strong> <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">bolt://localhost:7687</code> (æœ¬åœ°)<br>
                    â€¢ <strong>ç”¨æˆ·å:</strong> <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">neo4j</code> (é»˜è®¤)<br>
                    â€¢ <strong>å¯†ç :</strong> æ‚¨è®¾ç½®çš„å¯†ç <br><br>
                    
                    <strong>ğŸ”§ å¸¸è§é—®é¢˜ï¼š</strong><br>
                    â€¢ <strong>è®¤è¯å¤±è´¥ï¼Ÿ</strong> æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®<br>
                    â€¢ <strong>è¿æ¥å¤±è´¥ï¼Ÿ</strong> ç¡®ä¿ Neo4j æ­£åœ¨è¿è¡Œï¼ˆè®¿é—® <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">http://localhost:7474</code> æµ‹è¯•ï¼‰<br>
                    â€¢ <strong>é¦–æ¬¡ä½¿ç”¨ï¼Ÿ</strong> é»˜è®¤å¯†ç æ˜¯ <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">neo4j</code>ï¼Œç™»å½•åä¼šè¦æ±‚ä¿®æ”¹<br><br>
                    
                    <strong>ï¿½ï¸ äº¤äº’æ“ç¤ºä½œï¼š</strong><br>
                    â€¢ <strong>ç‚¹å‡»èŠ‚ç‚¹</strong>ï¼šæŸ¥çœ‹èŠ‚ç‚¹çš„è¯¦ç»†å±æ€§ä¿¡æ¯<br>
                    â€¢ <strong>ç‚¹å‡»è¾¹</strong>ï¼šæŸ¥çœ‹å…³ç³»çš„è¯¦ç»†ä¿¡æ¯<br>
                    â€¢ <strong>æ‹–æ‹½èŠ‚ç‚¹</strong>ï¼šè°ƒæ•´å›¾è°±å¸ƒå±€<br>
                    â€¢ <strong>æ»šè½®ç¼©æ”¾</strong>ï¼šæ”¾å¤§æˆ–ç¼©å°è§†å›¾<br><br>
                    
                    <strong>ğŸ“ å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹ï¼š</strong><br>
                    â€¢ æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹å’Œå…³ç³»: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">MATCH (n)-[r]->(m) RETURN n, r, m LIMIT 100</code><br>
                    â€¢ æŸ¥çœ‹ç‰¹å®šç±»å‹èŠ‚ç‚¹: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">MATCH (n:Entity) RETURN n LIMIT 50</code><br>
                    â€¢ æŸ¥çœ‹èŠ‚ç‚¹å…³ç³»: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">MATCH (n)-[r:RELATED_TO]->(m) RETURN n, r, m</code><br>
                    â€¢ æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹æ ‡ç­¾: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">CALL db.labels()</code>
                </div>
            </div> -->
        </div>

        <!-- ç´¢å¼•ä»»åŠ¡çŠ¶æ€é¢æ¿ -->
        <div class="main-card" id="tasksPanel" style="display: none;">
            <h2 style="color: #764ba2; margin-bottom: 15px;">ğŸ“‹ ç´¢å¼•ä»»åŠ¡çŠ¶æ€</h2>
            <p style="color: #666; margin-bottom: 20px;">æŸ¥çœ‹æ‰€æœ‰ç´¢å¼•æ›´æ–°ä»»åŠ¡çš„çŠ¶æ€å’Œè¯¦æƒ…</p>
            
            <div style="margin-bottom: 15px;">
                <button onclick="refreshTasks()" class="btn" style="background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); padding: 10px 20px; font-size: 16px;">
                    ğŸ”„ åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                </button>
            </div>

            <div id="tasksContainer" style="margin-top: 20px;">
                <div class="loading">åŠ è½½ä»»åŠ¡åˆ—è¡¨ä¸­...</div>
            </div>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ é¢æ¿ -->
        <div class="main-card" id="uploadPanel" style="display: none;">
            <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ“¤ ä¸Šä¼ æ–‡ä»¶æ›´æ–°ç´¢å¼•</h2>
            <p style="color: #666; margin-bottom: 20px;">
                æ”¯æŒ .txt å’Œ .pdf æ–‡ä»¶ã€‚ä¸Šä¼ åå°†è‡ªåŠ¨æ›´æ–°çŸ¥è¯†å›¾è°±ç´¢å¼•ï¼ˆä»…å¢é‡æ›´æ–°ï¼Œä¸ä¼šé‡å»ºï¼‰ã€‚<br>
                <strong>é…ç½®è¯´æ˜ï¼š</strong>ç´¢å¼•å‚æ•°ç”±é…ç½®æ–‡ä»¶æ§åˆ¶ï¼ŒTXT ä½¿ç”¨ settings.yamlï¼ŒPDF ä½¿ç”¨ settings_pdf.yaml
            </p>
            
            <div class="form-group">
                <label for="fileInput">é€‰æ‹©æ–‡ä»¶</label>
                <input type="file" id="fileInput" accept=".txt,.pdf" style="padding: 10px; border: 2px dashed #667eea; border-radius: 8px; width: 100%; cursor: pointer;">
                <div style="margin-top: 8px; font-size: 13px; color: #666;">
                    â€¢ TXT æ–‡ä»¶ï¼šä½¿ç”¨é»˜è®¤é…ç½® (settings.yaml)<br>
                    â€¢ PDF æ–‡ä»¶ï¼šä½¿ç”¨ PDF é…ç½® (settings_pdf.yaml)<br>
                    â€¢ å¦‚éœ€ä¿®æ”¹å‚æ•°ï¼ˆchunk sizeã€overlap ç­‰ï¼‰ï¼Œè¯·ç›´æ¥ç¼–è¾‘å¯¹åº”çš„é…ç½®æ–‡ä»¶
                </div>
            </div>

            <button onclick="uploadFile()" class="btn" id="uploadBtn" style="margin-top: 20px;">
                ğŸš€ ä¸Šä¼ å¹¶æ›´æ–°ç´¢å¼•
            </button>

            <div id="uploadStatus" style="margin-top: 20px; display: none;"></div>
        </div>

        <div class="main-card">
            <div style="margin-bottom: 20px;">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">æ£€æŸ¥æœåŠ¡çŠ¶æ€...</span>
            </div>

            <form id="queryForm">
                <div class="form-group">
                    <label for="query">æŸ¥è¯¢é—®é¢˜ *</label>
                    <textarea 
                        id="query" 
                        name="query" 
                        placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
                        required
                    ></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="queryType">æŸ¥è¯¢ç±»å‹</label>
                        <select id="queryType" name="query_type" onchange="updateQueryTypeInfo()">
                            <option value="local">Local Search (å±€éƒ¨æœç´¢)</option>
                            <option value="global">Global Search (å…¨å±€æœç´¢)</option>
                            <option value="drift">Drift Search (æ··åˆæœç´¢)</option>
                            <option value="basic">Basic Search (åŸºç¡€æœç´¢)</option>
                        </select>
                        <div id="queryTypeInfo" style="margin-top: 8px; padding: 8px; background: #f0f4ff; border-radius: 4px; font-size: 13px; color: #555; display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label for="responseType">å“åº”ç±»å‹</label>
                        <select id="responseType" name="response_type">
                            <option value="text">Text (æ–‡æœ¬)</option>
                            <option value="json">JSON</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="communityLevel">ç¤¾åŒºå±‚çº§</label>
                        <select id="communityLevel" name="community_level">
                            <option value="1">Level 1</option>
                            <option value="2">Level 2</option>
                            <option value="3">Level 3</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="dynamicSelectionGroup" style="display: none;">
                    <div class="checkbox-group">
                        <input 
                            type="checkbox" 
                            id="dynamicSelection" 
                            name="dynamic_community_selection"
                        >
                        <label for="dynamicSelection" style="margin: 0;">å¯ç”¨åŠ¨æ€ç¤¾åŒºé€‰æ‹©</label>
                    </div>
                    <div style="margin-top: 8px; padding: 10px; background: #e8f5e9; border-left: 3px solid #4caf50; border-radius: 4px; font-size: 13px; color: #2e7d32;">
                        <strong>ğŸ’¡ åŠ¨æ€ç¤¾åŒºé€‰æ‹©è¯´æ˜ï¼š</strong><br>
                        â€¢ æ ¹æ®æŸ¥è¯¢å†…å®¹æ™ºèƒ½é€‰æ‹©æœ€ç›¸å…³çš„ç¤¾åŒºæŠ¥å‘Š<br>
                        â€¢ æé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œå‡å°‘ä¸å¿…è¦çš„æ•°æ®å¤„ç†<br>
                        â€¢ é€‚åˆå¤§è§„æ¨¡çŸ¥è¯†å›¾è°±çš„ç²¾å‡†æŸ¥è¯¢<br>
                        â€¢ å¯èƒ½ä¼šå¢åŠ æŸ¥è¯¢æ—¶é—´ï¼Œä½†ç»“æœæ›´ç²¾å‡†
                    </div>
                </div>

                <button type="submit" class="btn" id="submitBtn">
                    ğŸš€ æ‰§è¡ŒæŸ¥è¯¢
                </button>
            </form>

            <div class="examples">
                <h3>ğŸ’¡ ç¤ºä¾‹é—®é¢˜</h3>
                <span class="example-btn" onclick="setExample('ç”Ÿç‰©å¿…ä¿®ä¸€éƒ½æœ‰å“ªäº›çŸ¥è¯†ç‚¹?')">ç”Ÿç‰©å¿…ä¿®ä¸€éƒ½æœ‰å“ªäº›çŸ¥è¯†ç‚¹?</span>
                <span class="example-btn" onclick="setExample('ä¸¾å‡ºä¸»åŠ¨è¿è¾“ï¼Œè¢«åŠ¨è¿è¾“ï¼Œè‡ªç”±æ‰©æ•£åœ¨ä¸åŒåœºæ™¯ä¸­çš„å®é™…ä¾‹å­')">ä¸¾å‡ºä¸»åŠ¨è¿è¾“ï¼Œè¢«åŠ¨è¿è¾“ï¼Œè‡ªç”±æ‰©æ•£åœ¨ä¸åŒåœºæ™¯ä¸­çš„å®é™…ä¾‹å­</span>
                <span class="example-btn" onclick="setExample('æ»¤çº¸æ¡çœ‹ä¸è§è‰²ç´ å¸¦çš„åŸå› æ˜¯ä»€ä¹ˆ')">æ»¤çº¸æ¡çœ‹ä¸è§è‰²ç´ å¸¦çš„åŸå› æ˜¯ä»€ä¹ˆ</span>
                <span class="example-btn" onclick="setExample('æœ‰ä¸åˆ†è£‚å’Œäººç±»é—ä¼ ç—…æœ‰ä»€ä¹ˆå…³ç³»')">æœ‰ä¸åˆ†è£‚å’Œäººç±»é—ä¼ ç—…æœ‰ä»€ä¹ˆå…³ç³»</span>
            </div>


        </div>

        <div class="result-card" id="resultCard">
            <div class="result-header">
                <h2>ğŸ“Š æŸ¥è¯¢ç»“æœ</h2>
                <button class="example-btn" onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
            </div>

            <div class="result-meta" id="resultMeta"></div>

            <div class="result-content" id="resultContent"></div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // è§£æ URL å‚æ•°å¹¶ç¼“å­˜
        function parseAndCacheURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const ip = urlParams.get('ip');
            const accessKey = urlParams.get('access_key');
            const neo4jPwd = urlParams.get('neo4jpwd');
            
            // ç¼“å­˜åˆ° localStorage
            if (ip) {
                localStorage.setItem('server_ip', ip);
                console.log('å·²ç¼“å­˜æœåŠ¡å™¨ IP:', ip);
            }
            if (accessKey) {
                localStorage.setItem('access_key', accessKey);
                console.log('å·²ç¼“å­˜è®¿é—®å¯†é’¥');
            }
            if (neo4jPwd) {
                localStorage.setItem('neo4j_password', neo4jPwd);
                console.log('å·²ç¼“å­˜ Neo4j å¯†ç ');
            }
            
            // è‡ªåŠ¨å¡«å……è¡¨å•
            autoFillForms();
        }

        // è‡ªåŠ¨å¡«å……è¡¨å•
        function autoFillForms() {
            const ip = localStorage.getItem('server_ip');
            const neo4jPwd = localStorage.getItem('neo4j_password');
            
            // è‡ªåŠ¨å¡«å…… Neo4j HTTP API URL
            if (ip) {
                const neo4jUrlInput = document.getElementById('neo4jHttpUrl');
                if (neo4jUrlInput) {
                    neo4jUrlInput.value = `${ip}/neo4j-db/neo4j`;
                }
            }
            
            // è‡ªåŠ¨å¡«å…… Neo4j å¯†ç 
            if (neo4jPwd) {
                const neo4jPwdInput = document.getElementById('neo4jPassword');
                if (neo4jPwdInput) {
                    neo4jPwdInput.value = neo4jPwd;
                }
            }
        }

        // è·å–ç¼“å­˜çš„ access_key
        function getAccessKey() {
            return localStorage.getItem('access_key') || '';
        }

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    document.getElementById('statusIndicator').className = 'status-indicator online';
                    document.getElementById('statusText').textContent = 'æœåŠ¡åœ¨çº¿ âœ“';
                } else {
                    throw new Error('Service not healthy');
                }
            } catch (error) {
                document.getElementById('statusIndicator').className = 'status-indicator offline';
                document.getElementById('statusText').textContent = 'æœåŠ¡ç¦»çº¿ âœ—';
            }
        }

        // è®¾ç½®ç¤ºä¾‹é—®é¢˜
        function setExample(text) {
            document.getElementById('query').value = text;
        }

        // æ›´æ–°æŸ¥è¯¢ç±»å‹ä¿¡æ¯
        function updateQueryTypeInfo() {
            const queryType = document.getElementById('queryType').value;
            const infoDiv = document.getElementById('queryTypeInfo');
            const dynamicGroup = document.getElementById('dynamicSelectionGroup');
            
            const descriptions = {
                'local': 'ğŸ’¡ <strong>å±€éƒ¨æœç´¢</strong>ï¼šåŸºäºå®ä½“åµŒå…¥çš„ç›¸ä¼¼åº¦åŒ¹é…ï¼Œå¿«é€Ÿå®šä½ç›¸å…³å®ä½“å’Œå…³ç³»ã€‚é€‚åˆï¼š"æŸä¸ªå®ä½“çš„è¯¦ç»†ä¿¡æ¯"ã€"ä¸¤ä¸ªæ¦‚å¿µä¹‹é—´çš„å…³ç³»"ç­‰å…·ä½“é—®é¢˜ã€‚',
                'global': 'ğŸ’¡ <strong>å…¨å±€æœç´¢</strong>ï¼šé€šè¿‡ç¤¾åŒºå±‚æ¬¡ç»“æ„åˆ†ææ•´ä½“æ•°æ®é›†ã€‚é€‚åˆï¼š"ä¸»è¦ä¸»é¢˜æœ‰å“ªäº›"ã€"æ•´ä½“è¶‹åŠ¿æ˜¯ä»€ä¹ˆ"ç­‰å®è§‚é—®é¢˜ã€‚',
                'drift': 'ğŸ’¡ <strong>æ··åˆæœç´¢</strong>ï¼šç»“åˆå±€éƒ¨å’Œå…¨å±€æ–¹æ³•ï¼Œé€šè¿‡å¤šè½®è¿­ä»£æ·±å…¥æ¢ç´¢ã€‚é€‚åˆï¼š"å¤æ‚çš„å¤šæ­¥æ¨ç†é—®é¢˜"ã€"éœ€è¦ç»¼åˆå¤šæ–¹é¢ä¿¡æ¯çš„æŸ¥è¯¢"ã€‚',
                'basic': 'ğŸ’¡ <strong>åŸºç¡€æœç´¢</strong>ï¼šç®€å•çš„æ–‡æœ¬å‘é‡ç›¸ä¼¼åº¦æœç´¢ï¼Œä¸ä½¿ç”¨çŸ¥è¯†å›¾è°±ç»“æ„ã€‚é€‚åˆï¼š"æŸ¥æ‰¾åŒ…å«ç‰¹å®šå…³é”®è¯çš„æ–‡æœ¬"ã€"å¿«é€Ÿæ–‡æœ¬æ£€ç´¢"ã€‚'
            };
            
            infoDiv.innerHTML = descriptions[queryType];
            infoDiv.style.display = 'block';
            
            // åªåœ¨ Global Search æ—¶æ˜¾ç¤ºåŠ¨æ€ç¤¾åŒºé€‰æ‹©
            if (queryType === 'global') {
                dynamicGroup.style.display = 'block';
            } else {
                dynamicGroup.style.display = 'none';
                document.getElementById('dynamicSelection').checked = false;
            }
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            document.getElementById('resultCard').classList.remove('show');
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            const resultCard = document.getElementById('resultCard');
            const resultContent = document.getElementById('resultContent');
            const errorMessage = document.getElementById('errorMessage');
            
            resultCard.classList.add('show');
            resultContent.innerHTML = '<div class="loading">æ­£åœ¨æŸ¥è¯¢ä¸­ï¼Œè¯·ç¨å€™</div>';
            errorMessage.style.display = 'none';
            document.getElementById('resultMeta').innerHTML = '';
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(data) {
            const resultContent = document.getElementById('resultContent');
            const resultMeta = document.getElementById('resultMeta');
            const errorMessage = document.getElementById('errorMessage');

            errorMessage.style.display = 'none';
            
            // ğŸ” DEBUG: æ‰“å°å®Œæ•´çš„æŸ¥è¯¢ç»“æœ
            console.log('=== GraphRAG æŸ¥è¯¢ç»“æœ DEBUG ===');
            console.log('å®Œæ•´æ•°æ®å¯¹è±¡:', data);
            console.log('æŸ¥è¯¢é—®é¢˜:', data.query);
            console.log('æŸ¥è¯¢ç±»å‹:', data.query_type);
            console.log('å“åº”å†…å®¹:', data.response);
            console.log('ä¸Šä¸‹æ–‡æ•°æ®:', data.context);
            console.log('================================');

            // æ˜¾ç¤ºå…ƒæ•°æ®
            resultMeta.innerHTML = `
                <div class="meta-item"><strong>æŸ¥è¯¢:</strong> ${data.query}</div>
                <div class="meta-item"><strong>ç±»å‹:</strong> ${data.query_type}</div>
                <div class="meta-item"><strong>æ—¶é—´:</strong> ${new Date().toLocaleString('zh-CN')}</div>
                <button onclick="visualizeQueryResults()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px; margin-left: 10px;">
                    ğŸ•¸ï¸ åœ¨å›¾è°±ä¸­æŸ¥çœ‹æŸ¥è¯¢ç»“æœä¸­çš„å®ä½“ã€å…³ç³»å’Œæ–‡æœ¬å—
                </button>
            `;
            
            // ä¿å­˜æŸ¥è¯¢ç»“æœåˆ°å…¨å±€å˜é‡ï¼Œä¾›å¯è§†åŒ–ä½¿ç”¨
            window.lastQueryResult = data;

            // æ¸²æŸ“ Markdown å†…å®¹
            try {
                // é…ç½® marked é€‰é¡¹
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    headerIds: true,
                    mangle: false
                });
                
                // å°† Markdown è½¬æ¢ä¸º HTML
                const htmlContent = marked.parse(data.response);
                resultContent.innerHTML = htmlContent;
            } catch (error) {
                console.error('Markdown parsing error:', error);
                // å¦‚æœè§£æå¤±è´¥ï¼Œæ˜¾ç¤ºçº¯æ–‡æœ¬
                resultContent.textContent = data.response;
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            const resultContent = document.getElementById('resultContent');
            
            resultContent.innerHTML = '';
            // ä½¿ç”¨ innerHTML ä»¥æ”¯æŒæ¢è¡Œå’Œæ ¼å¼åŒ–
            errorMessage.innerHTML = `âŒ é”™è¯¯: ${message.replace(/\n/g, '<br>')}`;
            errorMessage.style.display = 'block';
        }

        // å¤„ç†è¡¨å•æäº¤
        document.getElementById('queryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'â³ æŸ¥è¯¢ä¸­...';

            showLoading();

            try {
                const formData = new FormData(e.target);
                const params = new URLSearchParams();
                
                params.append('query', formData.get('query'));
                params.append('query_type', formData.get('query_type'));
                params.append('response_type', formData.get('response_type'));
                params.append('community_level', formData.get('community_level'));
                params.append('dynamic_community_selection', 
                    document.getElementById('dynamicSelection').checked);
                
                // æ·»åŠ  access_key
                const accessKey = getAccessKey();
                if (accessKey) {
                    params.append('access_key', accessKey);
                }

                const response = await fetch(`${API_BASE}/api/query?${params.toString()}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'æŸ¥è¯¢å¤±è´¥');
                }

                const data = await response.json();
                
                // ğŸ” DEBUG: æ‰“å°åŸå§‹å“åº”æ•°æ®
                console.log('=== API åŸå§‹å“åº” ===');
                console.log('å“åº”æ•°æ®:', data);
                console.log('==================');
                
                showResult(data);

            } catch (error) {
                console.error('Query error:', error);
                
                // ç‰¹æ®Šå¤„ç† Failed to fetch é”™è¯¯
                let errorMessage = error.message;
                if (errorMessage.includes('Failed to fetch') || errorMessage.includes('NetworkError') || errorMessage.includes('fetch')) {
                    errorMessage = 'âš ï¸ ç½‘ç»œè¿æ¥å¤±è´¥\n\n' +
                                 'å»ºè®®ï¼šè¯·ä¸è¦ä½¿ç”¨æ‰‹æœºè‡ªå¸¦æµè§ˆå™¨è®¿é—®\n' +
                                 'æ¨èä½¿ç”¨ï¼šå¤¸å…‹æµè§ˆå™¨ã€Chromeã€Safari ç­‰ç¬¬ä¸‰æ–¹æµè§ˆå™¨\n\n' +
                                 'åŸå› ï¼šéƒ¨åˆ†æ‰‹æœºè‡ªå¸¦æµè§ˆå™¨å¯¹ç½‘ç»œè¯·æ±‚æœ‰é™åˆ¶';
                }
                
                showError(errorMessage);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸš€ æ‰§è¡ŒæŸ¥è¯¢';
            }
        });

        // åˆ‡æ¢ä¸Šä¼ é¢æ¿
        function toggleUploadPanel() {
            const uploadPanel = document.getElementById('uploadPanel');
            const tasksPanel = document.getElementById('tasksPanel');
            const graphPanel = document.getElementById('graphPanel');
            
            if (uploadPanel.style.display === 'none') {
                uploadPanel.style.display = 'block';
                tasksPanel.style.display = 'none';
                graphPanel.style.display = 'none';
                uploadPanel.scrollIntoView({ behavior: 'smooth' });
            } else {
                uploadPanel.style.display = 'none';
            }
        }

        // åˆ‡æ¢ä»»åŠ¡é¢æ¿
        function toggleTasksPanel() {
            const uploadPanel = document.getElementById('uploadPanel');
            const tasksPanel = document.getElementById('tasksPanel');
            const graphPanel = document.getElementById('graphPanel');
            
            if (tasksPanel.style.display === 'none') {
                tasksPanel.style.display = 'block';
                uploadPanel.style.display = 'none';
                graphPanel.style.display = 'none';
                tasksPanel.scrollIntoView({ behavior: 'smooth' });
                refreshTasks();
            } else {
                tasksPanel.style.display = 'none';
            }
        }

        // åˆ‡æ¢å›¾è°±é¢æ¿
        function toggleGraphPanel() {
            const uploadPanel = document.getElementById('uploadPanel');
            const tasksPanel = document.getElementById('tasksPanel');
            const graphPanel = document.getElementById('graphPanel');
            
            if (graphPanel.style.display === 'none') {
                graphPanel.style.display = 'block';
                uploadPanel.style.display = 'none';
                tasksPanel.style.display = 'none';
                graphPanel.scrollIntoView({ behavior: 'smooth' });
            } else {
                graphPanel.style.display = 'none';
            }
        }

        function showGraphPanel() {
            const uploadPanel = document.getElementById('uploadPanel');
            const tasksPanel = document.getElementById('tasksPanel');
            const graphPanel = document.getElementById('graphPanel');
            
            if (graphPanel.style.display === 'none') {
                graphPanel.style.display = 'block';
                uploadPanel.style.display = 'none';
                tasksPanel.style.display = 'none';
                graphPanel.scrollIntoView({ behavior: 'smooth' });
            } 
        }

        // Neo4j HTTP API å¯è§†åŒ–ç›¸å…³
        let network = null;
        let nodes = null;
        let edges = null;

        async function executeNeo4jQuery() {
            const httpUrl = document.getElementById('neo4jHttpUrl').value;
            const user = document.getElementById('neo4jUser').value;
            const password = document.getElementById('neo4jPassword').value;
            const query = document.getElementById('cypherQuery').value;
            const statusDiv = document.getElementById('graphStatus');
            
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div style="color: #2196f3; font-weight: 600;">â³ æ­£åœ¨æŸ¥è¯¢...</div>';
            
            try {
                // æ„å»ºè®¤è¯å¤´
                const auth = btoa(`${user}:${password}`);
                
                // è°ƒç”¨ Neo4j HTTP API
                const response = await fetch(`${httpUrl}/tx/commit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Basic ${auth}`,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        statements: [{
                            statement: query,
                            resultDataContents: ['row', 'graph']
                        }]
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
                if (data.errors && data.errors.length > 0) {
                    throw new Error(data.errors[0].message);
                }
                
                // è§£æç»“æœ
                const results = data.results[0];
                if (!results || !results.data || results.data.length === 0) {
                    statusDiv.innerHTML = '<div style="color: #ff9800; font-weight: 600;">âš ï¸ æŸ¥è¯¢æˆåŠŸï¼Œä½†æ²¡æœ‰è¿”å›æ•°æ®</div>';
                    return;
                }
                
                // æå–å›¾æ•°æ®
                const graphData = extractGraphData(results.data);
                
                // æ¸²æŸ“å›¾è°±
                renderGraph(graphData);
                
                statusDiv.innerHTML = `<div style="color: #4caf50; font-weight: 600;">âœ… æŸ¥è¯¢æˆåŠŸï¼æ‰¾åˆ° ${graphData.nodes.length} ä¸ªèŠ‚ç‚¹ï¼Œ${graphData.edges.length} æ¡è¾¹</div>`;
                
            } catch (error) {
                console.error('Neo4j HTTP API error:', error);
                let errorMsg = error.message || String(error);
                
                // å¤„ç†å¸¸è§é”™è¯¯
                if (errorMsg.includes('401') || errorMsg.includes('authentication')) {
                    errorMsg = 'è®¤è¯å¤±è´¥ï¼šç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
                } else if (errorMsg.includes('404')) {
                    errorMsg = 'æ•°æ®åº“ä¸å­˜åœ¨æˆ– URL é”™è¯¯';
                } else if (errorMsg.includes('Failed to fetch') || errorMsg.includes('NetworkError')) {
                    errorMsg = 'âš ï¸ ç½‘ç»œè¿æ¥å¤±è´¥<br><br>' +
                             '<strong>å»ºè®®ï¼š</strong>è¯·ä¸è¦ä½¿ç”¨æ‰‹æœºè‡ªå¸¦æµè§ˆå™¨è®¿é—®<br>' +
                             '<strong>æ¨èä½¿ç”¨ï¼š</strong>å¤¸å…‹æµè§ˆå™¨ã€Chromeã€Safari ç­‰ç¬¬ä¸‰æ–¹æµè§ˆå™¨<br><br>' +
                             '<strong>åŸå› ï¼š</strong>éƒ¨åˆ†æ‰‹æœºè‡ªå¸¦æµè§ˆå™¨å¯¹ç½‘ç»œè¯·æ±‚æœ‰é™åˆ¶';
                }
                
                statusDiv.innerHTML = `
                    <div style="color: #f44336; font-weight: 600; padding: 15px; background: #ffebee; border-radius: 6px; border-left: 4px solid #f44336;">
                        <strong>âŒ æŸ¥è¯¢å¤±è´¥</strong><br>
                        <span style="font-size: 13px; font-weight: normal; margin-top: 8px; display: block;">${errorMsg}</span>
                    </div>
                `;
            }
        }

        // ä» Neo4j å“åº”ä¸­æå–å›¾æ•°æ®
        function extractGraphData(data) {
            const nodesMap = new Map();
            const edgesMap = new Map();
            
            data.forEach(record => {
                if (record.graph) {
                    // å¤„ç†èŠ‚ç‚¹
                    record.graph.nodes.forEach(node => {
                        if (!nodesMap.has(node.id)) {
                            const labels = node.labels || [];
                            const props = node.properties || {};
                            
                            nodesMap.set(node.id, {
                                id: node.id,
                                label: props.title || props.name || props.id || `Node ${node.id}`,
                                title: formatNodeTooltip(node),
                                group: labels[0] || 'default',
                                properties: props,
                                labels: labels
                            });
                        }
                    });
                    
                    // å¤„ç†è¾¹ï¼ˆä½¿ç”¨ Map å»é‡ï¼‰
                    record.graph.relationships.forEach(rel => {
                        if (!edgesMap.has(rel.id)) {
                            edgesMap.set(rel.id, {
                                id: rel.id,
                                from: rel.startNode,
                                to: rel.endNode,
                                label: rel.type,
                                title: formatEdgeTooltip(rel),
                                arrows: 'to',
                                properties: rel.properties || {},
                                type: rel.type
                            });
                        }
                    });
                }
            });
            
            return {
                nodes: Array.from(nodesMap.values()),
                edges: Array.from(edgesMap.values())
            };
        }

        // æ ¼å¼åŒ–èŠ‚ç‚¹æç¤ºä¿¡æ¯
        function formatNodeTooltip(node) {
            const props = node.properties || {};
            let tooltip = `<strong>Labels:</strong> ${(node.labels || []).join(', ')}<br>`;
            tooltip += `<strong>ID:</strong> ${node.id}<br>`;
            
            Object.keys(props).forEach(key => {
                const value = props[key];
                const displayValue = typeof value === 'string' && value.length > 50 
                    ? value.substring(0, 50) + '...' 
                    : value;
                tooltip += `<strong>${key}:</strong> ${displayValue}<br>`;
            });
            
            return tooltip;
        }

        // æ ¼å¼åŒ–è¾¹æç¤ºä¿¡æ¯
        function formatEdgeTooltip(rel) {
            const props = rel.properties || {};
            let tooltip = `<strong>Type:</strong> ${rel.type}<br>`;
            tooltip += `<strong>ID:</strong> ${rel.id}<br>`;
            
            Object.keys(props).forEach(key => {
                tooltip += `<strong>${key}:</strong> ${props[key]}<br>`;
            });
            
            return tooltip;
        }

        // æ¸²æŸ“å›¾è°±
        function renderGraph(graphData) {
            const container = document.getElementById('neo4jViz');
            
            // åˆ›å»º vis.js æ•°æ®é›†
            nodes = new vis.DataSet(graphData.nodes);
            edges = new vis.DataSet(graphData.edges);
            
            // é…ç½®é€‰é¡¹
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 20,
                    font: {
                        size: 14,
                        face: 'Tahoma'
                    },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    width: 2,
                    shadow: true,
                    smooth: {
                        type: 'continuous'
                    },
                    font: {
                        size: 12,
                        align: 'middle'
                    }
                },
                physics: {
                    enabled: true,
                    stabilization: {
                        iterations: 200
                    },
                    barnesHut: {
                        gravitationalConstant: -2000,
                        springConstant: 0.001,
                        springLength: 200
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 100,
                    navigationButtons: true,
                    keyboard: true
                }
            };
            
            // åˆ›å»ºç½‘ç»œ
            network = new vis.Network(container, { nodes, edges }, options);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const nodeData = nodes.get(nodeId);
                    displayFloatingNodeInfo(nodeData);
                } else if (params.edges.length > 0) {
                    const edgeId = params.edges[0];
                    const edgeData = edges.get(edgeId);
                    displayFloatingEdgeInfo(edgeData);
                } else {
                    // ç‚¹å‡»ç©ºç™½å¤„å…³é—­æµ®åŠ¨çª—å£
                    closeFloatingInfo();
                }
            });
        }

        // å…³é—­æµ®åŠ¨ä¿¡æ¯çª—å£
        function closeFloatingInfo() {
            const floatingInfo = document.getElementById('floatingNodeInfo');
            floatingInfo.style.display = 'none';
        }

        // æ˜¾ç¤ºæµ®åŠ¨èŠ‚ç‚¹ä¿¡æ¯
        function displayFloatingNodeInfo(nodeData) {
            const floatingInfo = document.getElementById('floatingNodeInfo');
            const floatingTitle = document.getElementById('floatingNodeTitle');
            const floatingContent = document.getElementById('floatingNodeContent');
            
            console.log('èŠ‚ç‚¹æ•°æ®:', nodeData); // è°ƒè¯•ç”¨
            
            // è·å–èŠ‚ç‚¹æ ‡ç­¾
            const labels = nodeData.labels || [];
            const labelText = Array.isArray(labels) ? labels.join(', ') : (labels || 'Node');
            const properties = nodeData.properties || {};
            
            // è®¾ç½®æ ‡é¢˜
            floatingTitle.textContent = `${labelText}`;
            
            let html = '';
            
            // æ ¹æ®èŠ‚ç‚¹ç±»å‹æ˜¾ç¤ºä¸åŒå†…å®¹
            if (labels.includes('__Relationship__')) {
                // Relationship èŠ‚ç‚¹ï¼šæ˜¾ç¤º description
                const description = properties.description || 'æ— æè¿°ä¿¡æ¯';
                html = `
                    <div style="padding: 12px; background: #f0f4ff; border-radius: 6px; border-left: 3px solid #667eea; margin-bottom: 10px;">
                        <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">ğŸ”— å…³ç³»æè¿°</div>
                        <div style="line-height: 1.6; color: #333;">${escapeHtml(description)}</div>
                    </div>
                `;
                
                // æ˜¾ç¤ºå…¶ä»–å…³é”®å±æ€§
                if (properties.source_id || properties.target_id) {
                    html += `
                        <div style="padding: 10px; background: #f9f9f9; border-radius: 6px; font-size: 12px;">
                            ${properties.source_id ? `<div style="margin-bottom: 4px;"><strong>æºå®ä½“:</strong> ${escapeHtml(properties.source_id)}</div>` : ''}
                            ${properties.target_id ? `<div><strong>ç›®æ ‡å®ä½“:</strong> ${escapeHtml(properties.target_id)}</div>` : ''}
                        </div>
                    `;
                }
                
            } else if (labels.includes('__Chunk__')) {
                // Chunk èŠ‚ç‚¹ï¼šæ˜¾ç¤º text
                const text = properties.text || 'æ— æ–‡æœ¬å†…å®¹';
                const displayText = text.length > 500 ? text.substring(0, 500) + '...' : text;
                html = `
                    <div style="padding: 12px; background: #fff3e0; border-radius: 6px; border-left: 3px solid #ff9800; margin-bottom: 10px;">
                        <div style="font-weight: 600; color: #ff9800; margin-bottom: 8px;">ğŸ“„ æ–‡æœ¬å†…å®¹</div>
                        <div style="line-height: 1.6; color: #333; white-space: pre-wrap; word-break: break-word;">${escapeHtml(displayText)}</div>
                        ${text.length > 500 ? '<div style="margin-top: 8px; color: #999; font-size: 11px;">(å†…å®¹å·²æˆªæ–­)</div>' : ''}
                    </div>
                `;
                
                // æ˜¾ç¤ºå…¶ä»–å…³é”®å±æ€§
                if (properties.n_tokens) {
                    html += `
                        <div style="padding: 10px; background: #f9f9f9; border-radius: 6px; font-size: 12px;">
                            <div><strong>Token æ•°é‡:</strong> ${properties.n_tokens}</div>
                        </div>
                    `;
                }
                
            } else if (labels.includes('__Entity__')) {
                // Entity èŠ‚ç‚¹ï¼šæ˜¾ç¤º description
                const description = properties.description || 'æ— æè¿°ä¿¡æ¯';
                const name = properties.name || properties.title || 'æœªå‘½åå®ä½“';
                html = `
                    <div style="padding: 12px; background: #e8f5e9; border-radius: 6px; border-left: 3px solid #4caf50; margin-bottom: 10px;">
                        <div style="font-weight: 600; color: #4caf50; margin-bottom: 8px;">ğŸ·ï¸ ${escapeHtml(name)}</div>
                        <div style="line-height: 1.6; color: #333;">${escapeHtml(description)}</div>
                    </div>
                `;
                
                // æ˜¾ç¤ºå…¶ä»–å…³é”®å±æ€§
                const additionalInfo = [];
                if (properties.type) additionalInfo.push(`<div><strong>ç±»å‹:</strong> ${escapeHtml(properties.type)}</div>`);
                if (properties.rank !== undefined) additionalInfo.push(`<div><strong>æ’å:</strong> ${properties.rank}</div>`);
                if (properties.degree !== undefined) additionalInfo.push(`<div><strong>åº¦æ•°:</strong> ${properties.degree}</div>`);
                
                if (additionalInfo.length > 0) {
                    html += `
                        <div style="padding: 10px; background: #f9f9f9; border-radius: 6px; font-size: 12px;">
                            ${additionalInfo.join('')}
                        </div>
                    `;
                }
                
            } else {
                // å…¶ä»–ç±»å‹èŠ‚ç‚¹ï¼šæ˜¾ç¤ºæ‰€æœ‰å±æ€§
                html = `
                    <div style="padding: 12px; background: #f5f5f5; border-radius: 6px;">
                        <div style="font-weight: 600; color: #666; margin-bottom: 8px;">ğŸ“‹ èŠ‚ç‚¹ä¿¡æ¯</div>
                `;
                
                const excludeKeys = ['id', 'identity', 'elementId', 'labels', 'label', 'group', 'x', 'y', 'vx', 'vy', 'fx', 'fy', 'raw'];
                const propertyKeys = Object.keys(properties).filter(key => !excludeKeys.includes(key) && !key.startsWith('_'));
                
                if (propertyKeys.length > 0) {
                    for (const key of propertyKeys) {
                        const value = properties[key];
                        let displayValue = value;
                        
                        if (typeof value === 'string' && value.length > 200) {
                            displayValue = value.substring(0, 200) + '...';
                        } else if (typeof value === 'object' && value !== null) {
                            displayValue = JSON.stringify(value);
                        } else {
                            displayValue = String(value);
                        }
                        
                        html += `
                            <div style="margin-bottom: 8px;">
                                <strong style="color: #667eea;">${key}:</strong>
                                <div style="margin-top: 2px; color: #333; word-break: break-word;">${escapeHtml(displayValue)}</div>
                            </div>
                        `;
                    }
                } else {
                    html += '<div style="color: #999;">æ— å±æ€§ä¿¡æ¯</div>';
                }
                
                html += '</div>';
            }
            
            floatingContent.innerHTML = html;
            floatingInfo.style.display = 'block';
        }

        // æ˜¾ç¤ºæµ®åŠ¨è¾¹ä¿¡æ¯
        function displayFloatingEdgeInfo(edgeData) {
            const floatingInfo = document.getElementById('floatingNodeInfo');
            const floatingTitle = document.getElementById('floatingNodeTitle');
            const floatingContent = document.getElementById('floatingNodeContent');
            
            console.log('è¾¹æ•°æ®:', edgeData); // è°ƒè¯•ç”¨
            
            const relType = edgeData.type || edgeData.label || 'å…³ç³»';
            const properties = edgeData.properties || {};
            
            floatingTitle.textContent = `ğŸ”— ${relType}`;
            
            let html = '';
            
            // æ˜¾ç¤ºæè¿°ï¼ˆå¦‚æœæœ‰ï¼‰
            if (properties.description) {
                html += `
                    <div style="padding: 12px; background: #f0f4ff; border-radius: 6px; border-left: 3px solid #764ba2; margin-bottom: 10px;">
                        <div style="font-weight: 600; color: #764ba2; margin-bottom: 8px;">æè¿°</div>
                        <div style="line-height: 1.6; color: #333;">${escapeHtml(properties.description)}</div>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
            html += `
                <div style="padding: 10px; background: #f9f9f9; border-radius: 6px; font-size: 12px; margin-bottom: 10px;">
                    <div style="margin-bottom: 4px;"><strong>èµ·å§‹èŠ‚ç‚¹:</strong> ${edgeData.from}</div>
                    <div><strong>ç»“æŸèŠ‚ç‚¹:</strong> ${edgeData.to}</div>
                </div>
            `;
            
            // æ˜¾ç¤ºå…¶ä»–å±æ€§
            const excludeKeys = ['id', 'identity', 'elementId', 'type', 'label', 'from', 'to', 'description', 'arrows', 'title'];
            const propertyKeys = Object.keys(properties).filter(key => !excludeKeys.includes(key) && !key.startsWith('_'));
            
            if (propertyKeys.length > 0) {
                html += '<div style="padding: 10px; background: #f5f5f5; border-radius: 6px; font-size: 12px;">';
                for (const key of propertyKeys) {
                    const value = properties[key];
                    html += `<div style="margin-bottom: 4px;"><strong>${key}:</strong> ${escapeHtml(String(value))}</div>`;
                }
                html += '</div>';
            }
            
            floatingContent.innerHTML = html;
            floatingInfo.style.display = 'block';
        }

        // HTML è½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è®¾ç½®è‡ªç„¶è¯­è¨€æŸ¥è¯¢ç¤ºä¾‹
        function setNLExample(text) {
            document.getElementById('nlQuery').value = text;
        }

        // è‡ªç„¶è¯­è¨€æŸ¥è¯¢è½¬ Cypher
        async function executeNLQuery() {
            const nlQuery = document.getElementById('nlQuery').value.trim();
            const neo4jUrl = document.getElementById('neo4jHttpUrl').value;
            const neo4jUser = document.getElementById('neo4jUser').value;
            const neo4jPassword = document.getElementById('neo4jPassword').value;
            const statusDiv = document.getElementById('graphStatus');
            const generatedCypherDiv = document.getElementById('generatedCypher');
            const generatedCypherCode = document.getElementById('generatedCypherCode');
            
            if (!nlQuery) {
                alert('è¯·è¾“å…¥è‡ªç„¶è¯­è¨€é—®é¢˜');
                return;
            }
            
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div style="color: #2196f3; font-weight: 600;">ğŸ¤– AI æ­£åœ¨ç”Ÿæˆ Cypher æŸ¥è¯¢...</div>';
            generatedCypherDiv.style.display = 'none';
            
            try {
                // è°ƒç”¨åç«¯ API
                const response = await fetch(`${API_BASE}/api/nl-to-cypher`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: nlQuery,
                        neo4j_url: neo4jUrl,
                        neo4j_user: neo4jUser,
                        neo4j_password: neo4jPassword,
                        access_key: getAccessKey()
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'AI æŸ¥è¯¢å¤±è´¥');
                }
                
                const data = await response.json();
                
                // æ˜¾ç¤ºç”Ÿæˆçš„ Cypher
                generatedCypherCode.textContent = data.cypher;
                generatedCypherDiv.style.display = 'block';
                
                // è‡ªåŠ¨å¡«å……åˆ° Cypher è¾“å…¥æ¡†
                document.getElementById('cypherQuery').value = data.cypher;
                
                // æå–å›¾æ•°æ®å¹¶æ¸²æŸ“
                if (data.results && data.results.results && data.results.results[0]) {
                    const results = data.results.results[0];
                    
                    if (!results.data || results.data.length === 0) {
                        statusDiv.innerHTML = '<div style="color: #ff9800; font-weight: 600;">âš ï¸ æŸ¥è¯¢æˆåŠŸï¼Œä½†æ²¡æœ‰è¿”å›æ•°æ®</div>';
                        return;
                    }
                    
                    // æå–å›¾æ•°æ®
                    const graphData = extractGraphData(results.data);
                    
                    // æ¸²æŸ“å›¾è°±
                    renderGraph(graphData);
                    
                    statusDiv.innerHTML = `<div style="color: #4caf50; font-weight: 600;">âœ… AI æŸ¥è¯¢æˆåŠŸï¼æ‰¾åˆ° ${graphData.nodes.length} ä¸ªèŠ‚ç‚¹ï¼Œ${graphData.edges.length} æ¡è¾¹</div>`;
                } else {
                    statusDiv.innerHTML = '<div style="color: #4caf50; font-weight: 600;">âœ… Cypher ç”ŸæˆæˆåŠŸï¼ç‚¹å‡»"â–¶ï¸ æ‰§è¡ŒæŸ¥è¯¢"æŸ¥çœ‹ç»“æœ</div>';
                }
                
            } catch (error) {
                console.error('NL to Cypher error:', error);
                let errorMsg = error.message || String(error);
                
                // å¤„ç†å¸¸è§é”™è¯¯
                if (errorMsg.includes('Failed to fetch') || errorMsg.includes('NetworkError') || errorMsg.includes('fetch')) {
                    errorMsg = 'âš ï¸ ç½‘ç»œè¿æ¥å¤±è´¥<br><br>' +
                             '<strong>å»ºè®®ï¼š</strong>è¯·ä¸è¦ä½¿ç”¨æ‰‹æœºè‡ªå¸¦æµè§ˆå™¨è®¿é—®<br>' +
                             '<strong>æ¨èä½¿ç”¨ï¼š</strong>å¤¸å…‹æµè§ˆå™¨ã€Chromeã€Safari ç­‰ç¬¬ä¸‰æ–¹æµè§ˆå™¨<br><br>' +
                             '<strong>åŸå› ï¼š</strong>éƒ¨åˆ†æ‰‹æœºè‡ªå¸¦æµè§ˆå™¨å¯¹ç½‘ç»œè¯·æ±‚æœ‰é™åˆ¶';
                } else if (errorMsg.includes('403') || errorMsg.includes('è®¿é—®è¢«æ‹’ç»')) {
                    errorMsg = 'è®¿é—®è¢«æ‹’ç»ï¼šéœ€è¦æœ‰æ•ˆçš„è®¿é—®å¯†é’¥';
                } else if (errorMsg.includes('401') || errorMsg.includes('authentication')) {
                    errorMsg = 'Neo4j è®¤è¯å¤±è´¥ï¼šç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
                } else if (errorMsg.includes('LLM')) {
                    errorMsg = 'AI æœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                }
                
                statusDiv.innerHTML = `
                    <div style="color: #f44336; font-weight: 600; padding: 15px; background: #ffebee; border-radius: 6px; border-left: 4px solid #f44336;">
                        <strong>âŒ AI æŸ¥è¯¢å¤±è´¥</strong><br>
                        <span style="font-size: 13px; font-weight: normal; margin-top: 8px; display: block;">${errorMsg}</span>
                    </div>
                `;
                generatedCypherDiv.style.display = 'none';
            }
        }

        // æ—§çš„ executeQuery å‡½æ•°å·²è¢« executeNeo4jQuery æ›¿ä»£
        function executeQuery() {
            // ä¸ºäº†å‘åå…¼å®¹ï¼Œè°ƒç”¨æ–°å‡½æ•°
            executeNeo4jQuery();
        }

        // å…¼å®¹æ€§å‡½æ•°
        function connectNeo4j() {
            // ä¸ºäº†å‘åå…¼å®¹ï¼Œè°ƒç”¨æ–°å‡½æ•°
            executeNeo4jQuery();
        }

        // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
        async function refreshTasks() {
            const container = document.getElementById('tasksContainer');
            container.innerHTML = '<div class="loading">åŠ è½½ä»»åŠ¡åˆ—è¡¨ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/index/tasks`);
                if (!response.ok) {
                    throw new Error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥');
                }

                const data = await response.json();
                const tasks = data.tasks || [];

                if (tasks.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 30px; text-align: center; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</div>
                            <div>æš‚æ— ç´¢å¼•ä»»åŠ¡</div>
                        </div>
                    `;
                    return;
                }

                // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
                tasks.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                let html = '<div style="display: grid; gap: 15px;">';
                
                for (const task of tasks) {
                    const statusColors = {
                        'pending': '#ff9800',
                        'running': '#2196f3',
                        'completed': '#4caf50',
                        'failed': '#f44336'
                    };
                    
                    const statusLabels = {
                        'pending': 'â³ ç­‰å¾…ä¸­',
                        'running': 'ğŸ”„ è¿è¡Œä¸­',
                        'completed': 'âœ… å®Œæˆ',
                        'failed': 'âŒ å¤±è´¥'
                    };

                    const statusColor = statusColors[task.status] || '#999';
                    const statusLabel = statusLabels[task.status] || task.status;

                    html += `
                        <div style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid ${statusColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 5px;">
                                        ${task.file_name}
                                    </div>
                                    <div style="font-size: 13px; color: #999;">
                                        ä»»åŠ¡ID: ${task.task_id}
                                    </div>
                                </div>
                                <div style="padding: 6px 12px; background: ${statusColor}; color: white; border-radius: 20px; font-size: 14px; font-weight: 600;">
                                    ${statusLabel}
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                <div style="padding: 10px; background: #f5f5f5; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">æ–‡ä»¶ç±»å‹</div>
                                    <div style="font-weight: 600; color: #333;">${task.file_type.toUpperCase()}</div>
                                </div>
                                <div style="padding: 10px; background: #f5f5f5; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">Chunk Size</div>
                                    <div style="font-weight: 600; color: #333;">${task.chunk_size || 500}</div>
                                </div>
                                <div style="padding: 10px; background: #f5f5f5; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">Chunk Overlap</div>
                                    <div style="font-weight: 600; color: #333;">${task.chunk_overlap || 100}</div>
                                </div>
                                <div style="padding: 10px; background: #f5f5f5; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">Max Gleanings</div>
                                    <div style="font-weight: 600; color: #333;">${task.max_gleanings || 1}</div>
                                </div>
                            </div>

                            <div style="padding: 10px; background: #f9f9f9; border-radius: 6px; margin-bottom: 10px;">
                                <div style="font-size: 12px; color: #999; margin-bottom: 3px;">æ¶ˆæ¯</div>
                                <div style="font-size: 14px; color: #333;">${task.message}</div>
                            </div>

                            <div style="font-size: 12px; color: #999; margin-bottom: 10px;">
                                åˆ›å»ºæ—¶é—´: ${new Date(task.created_at).toLocaleString('zh-CN')}
                            </div>

                            ${task.status === 'running' ? `
                                <button onclick="viewTaskLogs('${task.task_id}')" style="padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; margin-bottom: 10px;">
                                    ğŸ“Š æŸ¥çœ‹å®æ—¶è¿›åº¦
                                </button>
                                <div id="logs_${task.task_id}" style="display: none; margin-top: 10px;"></div>
                            ` : ''}

                            ${task.output ? `
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #667eea; font-size: 13px;">æŸ¥çœ‹è¯¦ç»†è¾“å‡º</summary>
                                    <pre style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 6px; font-size: 12px; overflow-x: auto; max-height: 300px;">${task.output}</pre>
                                </details>
                            ` : ''}
                        </div>
                    `;
                }

                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Refresh tasks error:', error);
                container.innerHTML = `
                    <div style="padding: 20px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px;">
                        <strong>âŒ åŠ è½½å¤±è´¥</strong><br>
                        <span style="font-size: 13px; color: #666;">${error.message}</span>
                    </div>
                `;
            }
        }

        // æŸ¥çœ‹ä»»åŠ¡å®æ—¶æ—¥å¿—
        let logPollingInterval = null;
        
        async function viewTaskLogs(taskId) {
            const logsDiv = document.getElementById(`logs_${taskId}`);
            
            if (logsDiv.style.display === 'block') {
                // éšè—æ—¥å¿—å¹¶åœæ­¢è½®è¯¢
                logsDiv.style.display = 'none';
                if (logPollingInterval) {
                    clearInterval(logPollingInterval);
                    logPollingInterval = null;
                }
                return;
            }
            
            // æ˜¾ç¤ºæ—¥å¿—
            logsDiv.style.display = 'block';
            logsDiv.innerHTML = '<div class="loading">åŠ è½½æ—¥å¿—ä¸­...</div>';
            
            // ç«‹å³åŠ è½½ä¸€æ¬¡
            await fetchTaskLogs(taskId);
            
            // æ¯3ç§’åˆ·æ–°ä¸€æ¬¡
            if (logPollingInterval) {
                clearInterval(logPollingInterval);
            }
            logPollingInterval = setInterval(() => fetchTaskLogs(taskId), 3000);
        }
        
        async function fetchTaskLogs(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/index/logs/${taskId}?lines=30`);
                if (!response.ok) {
                    throw new Error('è·å–æ—¥å¿—å¤±è´¥');
                }
                
                const data = await response.json();
                const logsDiv = document.getElementById(`logs_${taskId}`);
                
                if (!logsDiv || logsDiv.style.display === 'none') {
                    // æ—¥å¿—é¢æ¿å·²å…³é—­ï¼Œåœæ­¢è½®è¯¢
                    if (logPollingInterval) {
                        clearInterval(logPollingInterval);
                        logPollingInterval = null;
                    }
                    return;
                }
                
                // æ„å»ºè¿›åº¦æ¡
                const progress = data.progress || 0;
                const progressColor = progress === 100 ? '#4caf50' : '#2196f3';
                
                let html = `
                    <div style="padding: 15px; background: #f0f4ff; border-radius: 6px; border-left: 4px solid ${progressColor};">
                        <div style="margin-bottom: 10px;">
                            <strong style="color: ${progressColor};">ğŸ”„ å½“å‰å·¥ä½œæµ:</strong> 
                            <span style="margin-left: 8px; color: #333;">${data.current_workflow}</span>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-size: 12px; color: #666;">è¿›åº¦</span>
                                <span style="font-size: 12px; font-weight: 600; color: ${progressColor};">${progress}%</span>
                            </div>
                            <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${progress}%; height: 100%; background: ${progressColor}; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        
                        ${data.log_file ? `
                            <div style="font-size: 11px; color: #999;">
                                æ—¥å¿—æ–‡ä»¶: ${data.log_file}
                            </div>
                        ` : ''}
                    </div>
                    
                    <details open style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: #667eea; font-size: 13px; font-weight: 600;">ğŸ“‹ æœ€è¿‘æ—¥å¿— (${data.logs.length} è¡Œ)</summary>
                        <pre style="margin-top: 10px; padding: 10px; background: #2d2d2d; color: #f8f8f2; border-radius: 6px; font-size: 11px; overflow-x: auto; max-height: 400px; line-height: 1.4;">${data.logs.join('\n')}</pre>
                    </details>
                `;
                
                logsDiv.innerHTML = html;
                
                // å¦‚æœå®Œæˆäº†ï¼Œåœæ­¢è½®è¯¢
                if (progress === 100) {
                    if (logPollingInterval) {
                        clearInterval(logPollingInterval);
                        logPollingInterval = null;
                    }
                }
                
            } catch (error) {
                console.error('Fetch logs error:', error);
                const logsDiv = document.getElementById(`logs_${taskId}`);
                if (logsDiv) {
                    logsDiv.innerHTML = `
                        <div style="padding: 10px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px;">
                            <strong>âŒ åŠ è½½æ—¥å¿—å¤±è´¥</strong><br>
                            <span style="font-size: 12px; color: #666;">${error.message}</span>
                        </div>
                    `;
                }
            }
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const statusDiv = document.getElementById('uploadStatus');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }

            const file = fileInput.files[0];
            const fileExt = file.name.split('.').pop().toLowerCase();

            if (fileExt !== 'txt' && fileExt !== 'pdf') {
                alert('åªæ”¯æŒ .txt å’Œ .pdf æ–‡ä»¶');
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'â³ ä¸Šä¼ ä¸­...';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div class="loading">æ­£åœ¨ä¸Šä¼ æ–‡ä»¶</div>';

            try {
                const formData = new FormData();
                formData.append('file', file);
                
                // æ·»åŠ  access_key
                const accessKey = getAccessKey();
                if (accessKey) {
                    formData.append('access_key', accessKey);
                }

                const response = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ä¸Šä¼ å¤±è´¥');
                }

                const result = await response.json();
                
                statusDiv.innerHTML = `
                    <div style="padding: 15px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
                        <strong>âœ… ${result.message}</strong><br>
                        <span style="font-size: 13px; color: #666;">
                            æ–‡ä»¶: ${result.file_name} (${result.file_type})<br>
                            ä»»åŠ¡ID: ${result.task_id}
                        </span>
                    </div>
                    <div id="taskStatus_${result.task_id}" style="margin-top: 10px;"></div>
                `;

                // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                pollTaskStatus(result.task_id);

                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                fileInput.value = '';

            } catch (error) {
                console.error('Upload error:', error);
                statusDiv.innerHTML = `
                    <div style="padding: 15px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px;">
                        <strong>âŒ ä¸Šä¼ å¤±è´¥</strong><br>
                        <span style="font-size: 13px; color: #666;">${error.message}</span>
                    </div>
                `;
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ğŸš€ ä¸Šä¼ å¹¶æ›´æ–°ç´¢å¼•';
            }
        }

        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        async function pollTaskStatus(taskId) {
            const statusDiv = document.getElementById(`taskStatus_${taskId}`);
            
            const poll = async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/index/status/${taskId}`);
                    if (!response.ok) return;

                    const status = await response.json();
                    
                    let statusHtml = '';
                    if (status.status === 'pending') {
                        statusHtml = '<div class="loading">ç­‰å¾…å¤„ç†</div>';
                    } else if (status.status === 'running') {
                        statusHtml = '<div class="loading">æ­£åœ¨æ›´æ–°ç´¢å¼•ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ</div>';
                    } else if (status.status === 'completed') {
                        statusHtml = `
                            <div style="padding: 15px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
                                <strong>âœ… ${status.message}</strong><br>
                                <span style="font-size: 13px; color: #666;">ç´¢å¼•å·²æ›´æ–°ï¼Œå¯ä»¥å¼€å§‹æŸ¥è¯¢æ–°å†…å®¹äº†ï¼</span>
                            </div>
                        `;
                        return; // åœæ­¢è½®è¯¢
                    } else if (status.status === 'failed') {
                        statusHtml = `
                            <div style="padding: 15px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px;">
                                <strong>âŒ ${status.message}</strong>
                            </div>
                        `;
                        return; // åœæ­¢è½®è¯¢
                    }

                    statusDiv.innerHTML = statusHtml;

                    // å¦‚æœè¿˜åœ¨è¿è¡Œï¼Œç»§ç»­è½®è¯¢
                    if (status.status === 'pending' || status.status === 'running') {
                        setTimeout(poll, 3000); // æ¯3ç§’æŸ¥è¯¢ä¸€æ¬¡
                    }

                } catch (error) {
                    console.error('Poll error:', error);
                }
            };

            poll();
        }

        // å¯è§†åŒ–æŸ¥è¯¢ç»“æœä¸­çš„å®ä½“å’Œå…³ç³»
        async function visualizeQueryResults() {
            if (!window.lastQueryResult) {
                alert('æ²¡æœ‰å¯ç”¨çš„æŸ¥è¯¢ç»“æœ');
                return;
            }
            
            const data = window.lastQueryResult;
            
            // è§£æä¸Šä¸‹æ–‡æ•°æ®ï¼Œæå–å®ä½“ ID å’Œå…³ç³» ID
            let entityIds = [];
            let relationshipIds = [];
            
            try {
                // æå–å®ä½“ IDï¼šEntities (1699) æˆ– Entities (1699, 1727, 1723)
                const entityMatches = data.response.match(/Entities\s*\(([^)]+)\)/gi);
                if (entityMatches) {
                    entityMatches.forEach(match => {
                        const ids = match.match(/\d+/g);
                        if (ids) {
                            entityIds.push(...ids.map(id => parseInt(id)));
                        }
                    });
                }
                
                // æå–å…³ç³» IDï¼šRelationships (2634) æˆ– Relationships (2634, 2635)
                const relationshipMatches = data.response.match(/Relationships\s*\(([^)]+)\)/gi);
                if (relationshipMatches) {
                    relationshipMatches.forEach(match => {
                        const ids = match.match(/\d+/g);
                        if (ids) {
                            relationshipIds.push(...ids.map(id => parseInt(id)));
                        }
                    });
                }
                
                // å»é‡
                entityIds = [...new Set(entityIds)];
                relationshipIds = [...new Set(relationshipIds)];
                
                if (entityIds.length === 0 && relationshipIds.length === 0) {
                    alert('æŸ¥è¯¢ç»“æœä¸­æ²¡æœ‰æ‰¾åˆ°å®ä½“æˆ–å…³ç³»ä¿¡æ¯');
                    return;
                }
                
                console.log('æå–åˆ°çš„å®ä½“ ID:', entityIds);
                console.log('æå–åˆ°çš„å…³ç³» ID:', relationshipIds);
                
                // åˆ‡æ¢åˆ°å›¾è°±é¢æ¿
                showGraphPanel();
                
                // æ»šåŠ¨åˆ°å›¾è°±é¢æ¿
                document.getElementById('graphPanel').scrollIntoView({ behavior: 'smooth' });
                
                // æ„å»º Cypher æŸ¥è¯¢ - åŒ…å«å®ä½“ã€å…³ç³»èŠ‚ç‚¹å’Œç›¸å…³æ–‡æœ¬å—
                let cypherQuery = '';
                
                if (entityIds.length > 0 && relationshipIds.length > 0) {
                    // åŒæ—¶æŸ¥è¯¢å®ä½“ã€å…³ç³»èŠ‚ç‚¹å’Œç›¸å…³æ–‡æœ¬å—
                    cypherQuery = `
                        MATCH (e:__Entity__)
                        WHERE e.human_readable_id IN [${entityIds.join(', ')}]
                        OPTIONAL MATCH (e)-[edge:RELATED_TO]-(m:__Entity__)
                        OPTIONAL MATCH (chunk:__Chunk__)-[:MENTIONS]->(e)
                        WITH e, edge, m, collect(DISTINCT chunk) as chunks
                        OPTIONAL MATCH (rel:__Relationship__)
                        WHERE rel.human_readable_id IN [${relationshipIds.join(', ')}]
                        OPTIONAL MATCH (relChunk:__Chunk__)-[:HAS_RELATIONSHIP]->(rel)
                        RETURN e, edge, m, rel, chunks, collect(DISTINCT relChunk) as relChunks
                        LIMIT 200
                    `.trim();
                } else if (entityIds.length > 0) {
                    // æŸ¥è¯¢å®ä½“ã€ç›¸å…³å®ä½“å’Œæ–‡æœ¬å—
                    cypherQuery = `
                        MATCH (e:__Entity__)
                        WHERE e.human_readable_id IN [${entityIds.join(', ')}]
                        OPTIONAL MATCH (e)-[r:RELATED_TO]-(m:__Entity__)
                        OPTIONAL MATCH (chunk:__Chunk__)-[:MENTIONS]->(e)
                        RETURN e, r, m, collect(DISTINCT chunk) as chunks
                        LIMIT 200
                    `.trim();
                } else if (relationshipIds.length > 0) {
                    // æŸ¥è¯¢å…³ç³»èŠ‚ç‚¹å’Œç›¸å…³æ–‡æœ¬å—
                    cypherQuery = `
                        MATCH (rel:__Relationship__)
                        WHERE rel.human_readable_id IN [${relationshipIds.join(', ')}]
                        OPTIONAL MATCH (chunk:__Chunk__)-[:HAS_RELATIONSHIP]->(rel)
                        RETURN rel, collect(DISTINCT chunk) as chunks
                        LIMIT 200
                    `.trim();
                }
                
                // è®¾ç½®åˆ°æŸ¥è¯¢æ¡†
                document.getElementById('cypherQuery').value = cypherQuery;
                
                // æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯
                const graphStatus = document.getElementById('graphStatus');
                let statusMsg = '';
                if (entityIds.length > 0) {
                    statusMsg += `å®ä½“ ID: ${entityIds.join(', ')}`;
                }
                if (relationshipIds.length > 0) {
                    if (statusMsg) statusMsg += '<br>';
                    statusMsg += `å…³ç³» ID: ${relationshipIds.join(', ')}`;
                }
                
                graphStatus.innerHTML = `
                    <div style="padding: 10px; background: #e3f2fd; border-left: 3px solid #2196f3; border-radius: 4px;">
                        <strong>ğŸ” æ­£åœ¨æŸ¥è¯¢ï¼š</strong><br>
                        ${statusMsg}
                    </div>
                `;
                
                // è‡ªåŠ¨æ‰§è¡ŒæŸ¥è¯¢
                setTimeout(() => {
                    executeNeo4jQuery();
                }, 500);
                
            } catch (error) {
                console.error('è§£ææŸ¥è¯¢ç»“æœå¤±è´¥:', error);
                alert('è§£ææŸ¥è¯¢ç»“æœå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è§£æ URL å‚æ•°
        parseAndCacheURLParams();
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€
        checkHealth();
        
        // åˆå§‹åŒ–æŸ¥è¯¢ç±»å‹ä¿¡æ¯
        updateQueryTypeInfo();
        
        // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æœåŠ¡çŠ¶æ€
        setInterval(checkHealth, 30000);
    </script>
</body>
</html>
